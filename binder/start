#!/bin/bash

#Starting sshd server
/usr/sbin/sshd -f $(pwd)/resources/configs/ssh/sshd_config && \
sleep 1
# Adding names to know hosts. This step avoids yes/no host confirmation.
ssh -o "StrictHostKeyChecking no" $USER@localhost -p 8822 -C "exit" && \
ssh -o "StrictHostKeyChecking no" $USER@0.0.0.0   -p 8822 -C "exit"

# Copying configurations files to the Hadoop folder 
cp $(pwd)/resources/configs/hadoop/${HADOOP_VERSION}/core-site.xml   ${HADOOP_PATH}/etc/hadoop/ && \
cp $(pwd)/resources/configs/hadoop/${HADOOP_VERSION}/hdfs-site.xml   ${HADOOP_PATH}/etc/hadoop/

# Formatting the filesystem
${HADOOP_PATH}/bin/hdfs namenode -format -force -nonInteractive && \
sleep 1

${HADOOP_PATH}/sbin/start-dfs.sh && \
sleep 2

#Copying YARN configurations for Pseudo-Distributed Mode
cp $(pwd)/resources/configs/hadoop/${HADOOP_VERSION}/mapred-site.xml ${HADOOP_PATH}/etc/hadoop/ && \
cp $(pwd)/resources/configs/hadoop/${HADOOP_VERSION}/yarn-site.xml   ${HADOOP_PATH}/etc/hadoop/
${HADOOP_PATH}/sbin/start-yarn.sh 
sleep 2

${HADOOP_PATH}/bin/hdfs dfs -mkdir /user/
${HADOOP_PATH}/bin/hdfs dfs -mkdir /user/matheus/
${HADOOP_PATH}/bin/hdfs dfs -mkdir /user/$USER

echo "${USER} ${HADOOP_PATH}" > startresult.txt




# DO NOT REMOVE(!) 
# Here is why: https://mybinder.readthedocs.io/en/latest/config_files.html#start-run-code-before-the-user-sessions-starts
exec "$@"